(function(b){var c={zNodes:[],async:{enable:false,url:""},callback:{onCheck:function(d){}},checks:[],chkStyle:"checkbox",radioType:"all",height:"auto",direction:"auto",filter:true,slideModel:"click",searchShowParent:false,beforeSearchPromise:function(e,d){setTimeout(function(){e.resolve()},100)}};var a=function(f,e){this.$el=b(f);var g=this;if(!Function.prototype.bind){Function.prototype.bind=function(j){var h=this,i=arguments;return function(){h.apply(j,Array.prototype.slice.call(i,1))}}}var d=function(){return b.extend({},c,e,g.$el.data())};this.options=this.cloneObj(new d());this.init()};a.prototype={constructor:a,init:function(){var d=this.$el.attr("checks");if(!this.options.checks){this.options.checks=[]}if(d!=""&&d!=undefined&&d!=null){this.options.checks=b.merge(this.options.checks,d.split(","))}this.buildingDOM();this.initTree();this.bindEvent()},val:function(e){var d=this.$zTreeObj.getCheckedNodes(true);if(!e){e=[];b(d).each(function(g,h){e.push(h.id)});return e}else{var f=this;this.options.checks=e;b(d).each(function(g,h){h.checked=false;f.$zTreeObj.updateNode(h)});b(e).each(function(g,i){var h=f.$zTreeObj.getNodeByParam("id",i);h.checked=true;f.$zTreeObj.updateNode(h)});f.m2v();return this}},text:function(){var d=this.$zTreeObj.getCheckedNodes(true);var e=[];b(d).each(function(f,g){e.push(g.name)});return e},bindEvent:function(){if(this.options.slideModel=="click"){this.bindDrawerEventClick()}else{this.bindDrawerEventSlide()}if(this.options.filter){this.bindSearch()}},bindSearch:function(){this.searchTime=null;var d=this;this.clearbtn.click(function(){d.searchInput.val("");d.search_tree_el.hide();d.tree_el.show();if(d.$searchZTreeObj){d.$searchZTreeObj.destroy()}d.clearbtn.hide()});this.searchInput.keyup(function(e){var f=b(this).val().trim();if(f===""){d.clearbtn.hide()}else{d.clearbtn.show()}if(e.keyCode!==13){return false}if(d.options.beforeSearchPromise){b.Deferred(function(g){d.options.beforeSearchPromise(g,d)}).promise().then(function(){d.doSearch(f)})}else{d.doSearch(f)}})},beforeSearchPromise:function(){return},doSearch:function(e){var d=this;if(d.searchTime){clearTimeout(d.searchTime)}d.searchTime=setTimeout(function(){if(e===""){d.search_tree_el.hide();d.tree_el.show();if(d.$searchZTreeObj){d.$searchZTreeObj.destroy()}return}d.search_tree_el.show();d.tree_el.hide();var g=d.$zTreeObj.getNodesByParamFuzzy("name",e,null);var f=[];f=f.concat(g);if(d.options.searchShowParent){b(g).each(function(h,i){d.loadParents(i,f)})}d.initSearchTree(f)},500)},loadParents:function(f,d){var e=f.getParentNode();if(e){d.unshift(e);this.loadParents(e,d)}else{return}},randomID:function(d){return Number(Math.random().toString().substr(3,d)+new Date().getTime()).toString(36)},ifSlideUp:function(){var i=this;if(i.options.direction=="auto"){var k=document.body.clientHeight;var f=i.$el.height();var g=i.$el.offset().top;var d=b(document).scrollTop();var e=i.dropdown_container.height();var l=g-d;var h=k-l-(e+f);var j=l-e;if(h<10&&h<j){return true}else{return false}}else{if(i.options.direction!="up"){return false}else{return true}}},bindDrawerEventSlide:function(){var e=this.dropdown_container;var d=this;this.$el.click(function(f){if(d.ifSlideUp()){e.addClass("up");e.css("bottom",d.$el.outerHeight());e.css("top","")}else{e.css("bottom","");e.css("top",d.$el.outerHeight())}f.stopPropagation();if(!e.is(":visible")){e.slideDown("fast")}else{e.animate({height:"toggle",opacity:"toggle"},"fast")}});this.container.mouseleave(function(){if(e.is(":visible")){e.animate({height:"toggle",opacity:"toggle"},"fast")}})},bindDrawerEventClick:function(){var f=this.dropdown_container;var e=this;var d=function(g){if(!b(g.target).parents("#"+e.id).length>0){f.fadeOut("fast");b("body").unbind("mousedown",d)}};this.$el.click(function(){if(e.ifSlideUp()){f.addClass("up");f.css("bottom",e.$el.outerHeight());f.css("top","")}else{f.css("bottom","");f.css("top",e.$el.outerHeight())}if(!f.is(":visible")){f.slideDown("fast");b("body").bind("mousedown",d)}else{f.fadeOut("fast");b("body").unbind("mousedown",d)}})},buildingDOM:function(){this.$el.css({display:"block"});this.container=this.$el.wrap('<div class="mts-container"/>').parent();this.searchInput=b('<input class="searchInput" placeholder="按enter检索" type="text" style="width: '+(this.$el.outerWidth()-20)+'px;">');this.clearbtn=b('<span href="javascript:void(0);" class="clear">×</span>');var d=this.options.height+(this.options.height=="auto"?"":"px");this.tree_el=b('<ul class="ztree" style="height:'+d+"; width:"+(this.$el.outerWidth()-2)+'px;"></ul>');this.search_tree_el=b('<ul class="ztree" style="height:'+d+"; width:"+(this.$el.outerWidth()-2)+'px;"></ul>');this.dropdown_container=b('<div  class="dropdown_container"  ></div>');if(this.options.filter){this.dropdown_container.append(this.searchInput);this.dropdown_container.append(this.clearbtn)}this.dropdown_container.append(this.tree_el);this.dropdown_container.append(this.search_tree_el.hide());this.container.append(this.dropdown_container);this.id=this.randomID(3);
        this.dropdown_container.attr("id",this.id);this.tree_el.attr("id",this.randomID(3));this.search_tree_el.attr("id",this.randomID(3));return this.container},initDeafaultCheckedStatus:function(e){var f=this;var d=[];if(this.options.checks&&this.options.checks.length>0){b(e).each(function(g,h){var i=false;b(f.options.checks).each(function(j,k){if(k==h.id){i=true;if(h.checked!=true){h.checked=true;d.push(h)}return false}});if(!i){if(h.checked!=false){h.checked=false;d.push(h)}}})}return d},initTree:function(){var e=this;var d={check:{enable:true,chkboxType:{"Y":"","N":""},chkStyle:this.options.chkStyle,radioType:this.options.radioType},view:{dblClickExpand:false,showIcon:false},data:{simpleData:{enable:true}},callback:{onCheck:e.onCheck.bind(e),onAsyncSuccess:e.onAsyncSuccess.bind(e),onClick:function(i,h,g,f){e.$zTreeObj.checkNode(g,!g.checked,true);e.onCheck()}},async:this.options.async};d.async.dataFilter=function(h,f,g){if(g){e.initDeafaultCheckedStatus(g)}return g};e.initDeafaultCheckedStatus(this.options.zNodes);this.$zTreeObj=b.fn.zTree.init(this.tree_el,d,this.options.zNodes);this.onCheck();return this},initSearchTree:function(e){var f=this;var d={check:{enable:true,chkboxType:{"Y":"","N":""},chkStyle:this.options.chkStyle,radioType:this.options.radioType},view:{dblClickExpand:false,showIcon:false,fontCss:function(h,g){return{color:"#FFA200","font-weight":"bold"}}},data:{simpleData:{enable:true},key:{children:"nodes"}},callback:{onCheck:function(j,i,h){var g=f.$zTreeObj.getNodeByParam("id",h.id);f.$zTreeObj.checkNode(g,h.checked,true);f.onCheck()},onClick:function(j,i,h,g){f.$searchZTreeObj.checkNode(h,!h.checked,true);f.$searchZTreeObj.setting.callback.onCheck(j,i,h);f.onCheck()}}};this.$searchZTreeObj=b.fn.zTree.init(this.search_tree_el,d,e)},onCheck:function(g,f,d){this.m2v();this.options.callback.onCheck(this)},m2v:function(){var e=this.$zTreeObj.getCheckedNodes(true);var h="";var f="";for(var g=0,d=e.length;g<d;g++){h+=e[g].name+",";f+=e[g].id+","}if(h.length>0){h=h.substring(0,h.length-1)}if(f.length>0){f=f.substring(0,f.length-1)}this.$el.attr("checks",f);this.$el.val(h)},onAsyncSuccess:function(d,f,e,g){this.m2v();this.tree_el.find("a").mouseleave(function(){d.stopPropagation()});this.tree_el.find("span").mouseleave(function(){d.stopPropagation()})},cloneObj:function(f){var d={};if(f instanceof Array){d=[]}for(var e in f){var g=f[e];d[e]=typeof g==="object"?this.cloneObj(g):g}return d},destory:function(){if(this.container){b.data(this.$el[0],"treeSelect",undefined);this.container.replaceWith(this.$el);this.container=null;this.$zTreeObj.destroy();if(this.$searchZTreeObj){this.$searchZTreeObj.destroy()}}}};b.fn.treeSelect=function(d){var e=[];this.each(function(){var g=b(this);var f=g.data("treeSelect");if(!f){f=new a(this,d);b.data(this,"treeSelect",f)}e.push(f)});return e.length==1?e[0]:e}})(jQuery);